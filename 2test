<div class="w-full max-w-2xl mt-4 card p-6 sm:p-8">
    <!-- рд╣реЗрдбрд░ (Header) -->
    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 text-center mb-2">
       KYA KHAYEGA
    </h1>
    <p class="text-center text-gray-500 mb-8">
       CHAL BATA KYA HAI KITCHEN MAI,MAI JAADU DIKHATA HU
    </p>

    <!-- рд╕рд╛рдордЧреНрд░реА рдЗрдирдкреБрдЯ (Ingredients Input) -->
    <div class="mb-6">
        <label for="ingredients" class="block text-lg font-medium text-gray-700 mb-2">
           TERAI PASS JO HAI LIKH DAI CHUP-CHAP{ex. ATTA,DAAL,CHINI,NAKAM,OR SINGLE HU BHI CHAL SAKTA HAIЁЯШВ}
        </label>
        <textarea id="ingredients" rows="4" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-red-500 focus:border-red-500 transition duration-150" placeholder="рдЪрд╛рд╡рд▓, рджрд╛рд▓, рдЖрд▓реВ, рд╣рд░реА рдорд┐рд░реНрдЪ, рджрд╣реА, рдирдордХ..."></textarea>
    </div>

    <!-- рдмрдЯрди рдФрд░ рд▓реЛрдбрд┐рдВрдЧ рдЗрдВрдбрд┐рдХреЗрдЯрд░ (Button and Loading Indicator) -->
    <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
        <button id="generateBtn" class="btn-primary text-white font-semibold py-3 px-6 rounded-xl w-full sm:w-auto shadow-lg hover:shadow-xl flex items-center justify-center">
            рд░реЗрд╕рд┐рдкреА рддреИрдпрд╛рд░ рдХрд░реЗрдВ
        </button>
        <div id="loadingIndicator" class="hidden text-red-600 font-medium flex items-center space-x-2">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6"></div>
            <span>AJ KHANA TERA BHAI SET KAREGA..</span>
        </div>
        <p id="errorBox" class="text-red-500 hidden font-semibold mt-4"></p>
    </div>

    <!-- рд░реЗрд╕рд┐рдкреА рдЖрдЙрдЯрдкреБрдЯ (Recipe Output) -->
    <div id="recipeOutput" class="mt-10 pt-6 border-t border-gray-200">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 hidden" id="outputHeader">
            ЁЯТб TERAI LIYA SUGGEST KIYA HAI PYAR SAIЁЯдд
        </h2>
        <div id="recipeContent" class="prose max-w-none">
            <!-- рд░реЗрд╕рд┐рдкреА рдпрд╣рд╛рдБ рдкреНрд░рджрд░реНрд╢рд┐рдд рд╣реЛрдЧреА -->
        </div>
    </div>
</div>

<script>
    // *******************************************************************
    // ******* рдЖрдкрдХреА API Key рдпрд╣рд╛рдБ рдбрд╛рд▓ рджреА рдЧрдИ рд╣реИ (FINAL VERSION) *******
    // *******************************************************************
    const apiKey = "AIzaSyAEtLV55mMB3_PX5Ln3BFkdv8Dg3sApPyU"; 
    
    // рдмрд╛рдХреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const modelName = 'gemini-2.5-flash-preview-09-2025';
    
    // API URL рдореЗрдВ Key рдХреЛ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ (рд╕рдмрд╕реЗ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рддрд░реАрдХрд╛)
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`; 

    const ingredientsInput = document.getElementById('ingredients');
    const generateBtn = document.getElementById('generateBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const recipeOutput = document.getElementById('recipeOutput');
    const recipeContent = document.getElementById('recipeContent');
    const outputHeader = document.getElementById('outputHeader');
    const errorBox = document.getElementById('errorBox');

    // рд▓реЛрдбрд░ CSS
    const style = document.createElement('style');
    style.textContent = `
        .loader {
            border-top-color: #ef4444;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);


    // API рдХреЙрд▓ рдХреЗ рд▓рд┐рдП рдПрдХреНрд╕рдкреЛрдиреЗрдВрд╢рд┐рдпрд▓ рдмреИрдХрдСрдл
    async function fetchWithExponentialBackoff(url, options, maxRetries = 5) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, options);

                if (response.status === 429 && i < maxRetries - 1) {
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue; 
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    const errorMessage = `API рдЕрдиреБрд░реЛрдз рд╡рд┐рдлрд▓: ${response.status} ${response.statusText}. рд╡рд┐рд╡рд░рдг: ${errorText}`;
                    console.error("API рддреНрд░реБрдЯрд┐:", errorMessage);
                    throw new Error(errorMessage);
                }
                
                return response; // рд╕рдлрд▓ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛
            } catch (error) {
                console.error('fetch рдХреЗ рджреМрд░рд╛рди рдПрдХ рддреНрд░реБрдЯрд┐ рд╣реБрдИ:', error.message);
                
                if (i === maxRetries - 1) {
                    throw error; 
                }
                
                const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }

    async function generateRecipe() {
        // рдпрджрд┐ Key рдЧрд▓рддреА рд╕реЗ рд╣рдЯ рдЧрдИ рд╣реЛ рддреЛ рдЪреЗрдХ рдХрд░реЗрдВ
        if (apiKey === "" || !apiKey.startsWith("AIzaSy")) {
            errorBox.textContent = "рддреНрд░реБрдЯрд┐: API Key рд╕рд╣реА рд╕реЗ рд╕реЗрдЯ рдирд╣реАрдВ рд╣реИред";
            errorBox.classList.remove('hidden');
            return;
        }

        const ingredients = ingredientsInput.value.trim();

        if (!ingredients) {
            errorBox.textContent = "рдХреГрдкрдпрд╛ рдЕрдкрдиреА рд╕рд╛рдордЧреНрд░реА рдХреА рд╕реВрдЪреА рджрд░реНрдЬ рдХрд░реЗрдВред";
            errorBox.classList.remove('hidden');
            return;
        }

        // UI рд╕реНрдЯреЗрдЯ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
        errorBox.classList.add('hidden');
        generateBtn.disabled = true;
        generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
        loadingIndicator.classList.remove('hidden');
        recipeContent.innerHTML = '';
        outputHeader.classList.add('hidden');

        const systemPrompt = "рдЖрдк рдПрдХ рд░рдЪрдирд╛рддреНрдордХ, рд╕рд╣рд╛рдпрдХ рд╢реЗрдл (рд░рд╕реЛрдИ рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ) рд╣реИрдВред рдЖрдкрдХрд╛ рдХрд╛рдо рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рджрд╛рди рдХреА рдЧрдИ рд╕рд╛рдордЧреНрд░реА рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдПрдХ рд╕реНрд╡рд╛рджрд┐рд╖реНрдЯ рдФрд░ рдмрдирд╛рдиреЗ рдореЗрдВ рдЖрд╕рд╛рди рд╡реНрдпрдВрдЬрди (рд░реЗрд╕рд┐рдкреА) рдХрд╛ рд╕реБрдЭрд╛рд╡ рджреЗрдирд╛ рд╣реИред рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╣рд┐рдВрджреА рдореЗрдВ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред рдЙрддреНрддрд░ рдХреЛ рдПрдХ рдЖрдХрд░реНрд╖рдХ рд╢реАрд░реНрд╖рдХ, 'рдЖрд╡рд╢реНрдпрдХ рд╕рд╛рдордЧреНрд░реА' (рдХреЗрд╡рд▓ рд╡реЗ рдЬреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдиреЗ рдкреНрд░рджрд╛рди рдХреА рд╣реИрдВ) рдХреА рд╕реВрдЪреА, 'рддреИрдпрд╛рд░реА рдХрд╛ рд╕рдордп', рдФрд░ 'рдмрдирд╛рдиреЗ рдХреА рд╡рд┐рдзрд┐' рдХреЗ рд╕рд╛рде рд╡рд┐рд╕реНрддреГрдд рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рд╕рдВрд░рдЪрд┐рдд рдХрд░реЗрдВред рдХреЗрд╡рд▓ рдЙрдиреНрд╣реАрдВ рд╡реНрдпрдВрдЬрдиреЛрдВ рдХрд╛ рд╕реБрдЭрд╛рд╡ рджреЗрдВ рдЬреЛ рдЙрдкрд▓рдмреНрдз рд╕рд╛рдордЧреНрд░реА рд╕реЗ рдмрди рд╕рдХреЗрдВ, рдпрд╛ рдХрдо рд╕реЗ рдХрдо рдЙрдирдореЗрдВ 90% рд╕рд╛рдордЧреНрд░реА рдЙрдкрд▓рдмреНрдз рд╣реЛред";
        
        const userQuery = `рдореЗрд░реЗ рдкрд╛рд╕ рдпреЗ рд╕рд╛рдордЧреНрд░реА рд╣реИрдВ: ${ingredients}ред рдореБрдЭреЗ рдХреНрдпрд╛ рдмрдирд╛рдирд╛ рдЪрд╛рд╣рд┐рдП? рдореБрдЭреЗ рдПрдХ рд╡рд┐рд╕реНрддреГрдд рд░реЗрд╕рд┐рдкреА рдЪрд╛рд╣рд┐рдПред`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        const options = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        };

        try {
            const response = await fetchWithExponentialBackoff(apiUrl, options);
            const result = await response.json();
            
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const text = candidate.content.parts[0].text;
                recipeContent.innerHTML = formatMarkdownToHtml(text);
                outputHeader.classList.remove('hidden');
            } else {
                console.error("рдЕрдкреЗрдХреНрд╖рд┐рдд API рдкрд░рд┐рдгрд╛рдо рд╕рдВрд░рдЪрдирд╛ рдирд╣реАрдВ рдорд┐рд▓реАред рдкреВрд░реНрдг рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛:", result);
                errorBox.textContent = "рд░реЗрд╕рд┐рдкреА рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдореЗрдВ рдХреЛрдИ рд╕рдорд╕реНрдпрд╛ рдЖрдИред рдХреГрдкрдпрд╛ рд╕рд╛рдордЧреНрд░реА рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ рдФрд░ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред";
                errorBox.classList.remove('hidden');
            }

        } catch (error) {
            console.error('Gemini API рдХреЙрд▓ рддреНрд░реБрдЯрд┐ (рдореБрдЦреНрдп рдХреИрдЪ):', error);
            errorBox.textContent = `рд░реЗрд╕рд┐рдкреА рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдореЗрдВ рд╕рдорд╕реНрдпрд╛: рдиреЗрдЯрд╡рд░реНрдХ рддреНрд░реБрдЯрд┐ рдпрд╛ рд╕рд░реНрд╡рд░ рд╕реЗ рдЕрд╡реИрдз рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ред рдХреГрдкрдпрд╛ рдХрдВрд╕реЛрд▓ (F12) рдореЗрдВ рд╡рд┐рд╡рд░рдг рджреЗрдЦреЗрдВред`;
            errorBox.classList.remove('hidden');
        } finally {
            generateBtn.disabled = false;
            generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            loadingIndicator.classList.add('hidden');
        }
    }

    // рдорд╛рд░реНрдХрдбрд╛рдЙрди рдХреЛ HTML рдореЗрдВ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд░рд▓ рдлрд╝рдВрдХреНрд╢рди
    function formatMarkdownToHtml(markdown) {
        // рдмреЛрд▓реНрдб, рд╣реЗрдбрд┐рдВрдЧреНрд╕, рдФрд░ рд╕реВрдЪрд┐рдпреЛрдВ рдХреЛ рд╕рдВрднрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд░рд▓ рдкрд░рд┐рд╡рд░реНрддрди
        let html = markdown
            .replace(/^## (.*$)/gim, '<h3 class="text-xl font-semibold mt-4 mb-2 text-gray-700">$1</h3>') // H2 рдХреЛ H3 рдореЗрдВ
            .replace(/^# (.*$)/gim, '<h2 class="text-2xl font-bold mt-6 mb-3 text-red-600">$1</h2>') // H1 рдХреЛ H2 рдореЗрдВ
            .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>') // рдмреЛрд▓реНрдб
            .replace(/^- (.*$)/gim, '<li>$1</li>') // рдмреБрд▓реЗрдЯреЗрдб рд╕реВрдЪреА рдЖрдЗрдЯрдо
            .replace(/\* (.*$)/gim, '<li>$1</li>'); // рдмреБрд▓реЗрдЯреЗрдб рд╕реВрдЪреА рдЖрдЗрдЯрдо (рд╡реИрдХрд▓реНрдкрд┐рдХ)

        // рдпрджрд┐ рд╕реВрдЪреА рдЖрдЗрдЯрдо рд╣реИрдВ, рддреЛ рдЙрдиреНрд╣реЗрдВ ul рдЯреИрдЧ рдореЗрдВ рд▓рдкреЗрдЯреЗрдВ
        if (html.includes('<li>')) {
            html = html.replace(/(<li>.*<\/li>)/gs, '<ul class="list-disc pl-5 space-y-2 text-gray-600 mb-4">$1</ul>');
        }
        
        // рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рд▓рдЧрд╛рддрд╛рд░ рдмреБрд▓реЗрдЯ рдкреЙрдЗрдВрдЯреНрд╕ рдПрдХ рд╣реА ul рдореЗрдВ рд░рд╣реЗрдВ
        html = html.replace(/<\/ul>\s*<ul class="list-disc pl-5 space-y-2 text-gray-600 mb-4">/g, '');

        // рдкреИрд░рд╛рдЧреНрд░рд╛рдл рдХреЛ <p> рдЯреИрдЧ рдореЗрдВ рд▓рдкреЗрдЯреЗрдВ
        // рдпрд╣ рдереЛрдбрд╝рд╛ рдЬрдЯрд┐рд▓ рд╣реИ, рд▓реЗрдХрд┐рди рд╕рд░рд▓ рдЯреЗрдХреНрд╕реНрдЯ рд▓рд╛рдЗрдиреЛрдВ рдХреЛ рдкреИрд░рд╛рдЧреНрд░рд╛рдл рдореЗрдВ рдмрджрд▓рддрд╛ рд╣реИ
        html = html.split('\n').map(line => {
            line = line.trim();
            // рдЙрди рд▓рд╛рдЗрдиреЛрдВ рдХреЛ рдЕрдирджреЗрдЦрд╛ рдХрд░реЗрдВ рдЬреЛ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдХрд┐рд╕реА рдЯреИрдЧ рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рд╣реИрдВ
            if (line === '' || line.startsWith('<h') || line.startsWith('<ul') || line.startsWith('<li>') || line.startsWith('<strong>')) {
                return line;
            }
            // рдЕрдиреНрдпрдерд╛, рдЗрд╕реЗ рдПрдХ рдкреИрд░рд╛рдЧреНрд░рд╛рдл рдХреЗ рд░реВрдк рдореЗрдВ рдорд╛рдиреЗрдВ
            return `<p class="mb-4 text-gray-600 leading-relaxed">${line}</p>`;
        }).join('\n');


        return html;
    }

    generateBtn.addEventListener('click', generateRecipe);
    ingredientsInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            generateRecipe();
        }
    });
</script>
